<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ورشة عباس أشلاف – حجز مواعيد الصيانة</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Cairo', system-ui, sans-serif;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      color: #1e293b;
      min-height: 100vh;
      padding: 20px 15px;
      line-height: 1.6;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { text-align:center; margin: 1rem 0 2rem; color:#0f172a; font-size:2.2rem; }

    .lang-switcher {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .lang-btn {
      background: #1e40af;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      margin: 0 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
    }
    .lang-btn.active { background: #3b82f6; }

    .mechanic-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      padding: 2rem;
      margin-bottom: 2.5rem;
      text-align: center;
    }
    .mechanic-card img {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 1rem;
      border: 4px solid #3b82f6;
    }
    .mechanic-card h2 { color: #1e40af; margin-bottom: 0.8rem; }
    .phone-number {
      font-size: 1.4rem;
      font-weight: bold;
      color: #1e40af;
      margin: 1rem 0;
      display: block;
    }
    .phone-number a {
      color: #1e40af;
      text-decoration: none;
    }
    .phone-number a:hover {
      text-decoration: underline;
    }

    .cards-wrapper {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .card-header {
      background: #1e40af;
      color: white;
      padding: 1.3rem 1.8rem;
      font-size: 1.35rem;
      font-weight: 600;
    }

    .card-body { padding: 1.8rem; }

    .working-hours li {
      display: flex;
      justify-content: space-between;
      padding: 0.8rem 0;
      border-bottom: 1px dashed #e2e8f0;
    }
    .working-hours li:last-child { border-bottom: none; }
    .closed { color: #ef4444; font-weight: 600; }

    .booked-list { list-style: none; }
    .booked-item {
      padding: 1.1rem;
      margin-bottom: 1rem;
      background: #f8fafc;
      border-radius: 10px;
      border-right: 5px solid #3b82f6;
    }
    .booked-header { display: flex; justify-content: space-between; font-weight: 600; margin-bottom: 0.4rem; }
    .status {
      font-size: 0.9rem;
      padding: 0.3rem 0.8rem;
      border-radius: 999px;
      background: #dbeafe;
      color: #1d4ed8;
    }
    .empty { text-align:center; color:#64748b; font-style:italic; padding:2rem 0; }

    #booking-form { background:white; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,0.08); padding:2.5rem; }
    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:1.4rem; }
    .full { grid-column:1/-1; }
    label { display:block; margin-bottom:0.5rem; font-weight:500; color:#334155; }
    input, select, textarea {
      width:100%; padding:0.9rem; border:1px solid #cbd5e1; border-radius:8px; font-size:1rem;
    }
    input:focus, select:focus, textarea:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.15); }
    button {
      background:#2563eb; color:white; border:none; padding:1rem 2.5rem; font-size:1.1rem; font-weight:600;
      border-radius:10px; cursor:pointer; margin:2rem auto 0; display:block;
    }
    button:hover { background:#1d4ed8; }
    #message { margin-top:1.5rem; text-align:center; font-weight:500; padding:12px; border-radius:8px; }
    .success { background:#dcfce7; color:#166534; }
    .error { background:#fee2e2; color:#991b1b; }

    #safety-advice {
      margin-top: 1.5rem;
      padding: 1.2rem;
      background: #fefce8;
      border: 1px solid #eab308;
      border-radius: 8px;
      color: #713f12;
      font-size: 1rem;
    }
    #safety-advice h4 { margin-bottom: 0.8rem; color: #854d0e; }

    /* ميزة الدردشة */
    #chat-section {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      padding: 1.8rem;
      margin-top: 3rem;
    }
    #chat-messages {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 1rem;
      padding: 1rem;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
    }
    .chat-message {
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 8px;
      background: #f8fafc;
    }
    .chat-message.user { background: #dbeafe; color: #1d4ed8; }
    .chat-message.mechanic { background: #d1fae5; color: #065f46; }
    .chat-input {
      display: flex;
      gap: 0.5rem;
    }
    #chat-input { flex: 1; }
    #chat-send { background: #2563eb; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer; }

    @media (max-width: 700px) { .form-grid { grid-template-columns:1fr; } .chat-input { flex-direction: column; } }
  </style>
</head>
<body data-lang="ar">

<div class="container">
  <div class="lang-switcher">
    <button class="lang-btn active" data-lang="ar">العربية</button>
    <button class="lang-btn" data-lang="fr">Français</button>
    <button class="lang-btn" data-lang="en">English</button>
  </div>

  <!-- بطاقة عباس أشلاف -->
  <div class="mechanic-card">
    <img src="https://via.placeholder.com/180?text=عباس+أشلاف" alt="عباس أشلاف">
    <h2 data-key="mechanic-name">عباس أشلاف</h2>
    <a href="tel:0550813883" class="phone-number">☎ 0550 81 38 83</a>
    <p data-key="mechanic-desc">ميكانيكي محترف بخبرة تزيد عن 20 سنة في صيانة وإصلاح السيارات الأوروبية باحترافية عالية. متخصص بشكل خاص في مجموعة فولكس فاغن (Volkswagen, Škoda, Audi, SEAT León, SEAT Ibiza وغيرها). يمتلك خبرة عميقة في أنظمة الحقن الإلكتروني، التربو، DSG، نظام التعليق المتكيف، والتشخيص المتقدم بأحدث الأجهزة.</p>
    <p data-key="mechanic-bio"><strong>سيرة ذاتية مختصرة:</strong> يمتلك عباس أشلاف خبرة تفوق 20 عامًا في مجال صيانة وإصلاح السيارات، مع تركيز قوي ومتخصص على ماركات مجموعة فولكس فاغن (فولكس فاغن، سكودا، أودي، سيات ليون، سيات إيبيزا وموديلات أخرى). يشتهر بالدقة الفائقة في التشخيص، استخدام أحدث تقنيات OBD والبرمجة، والحلول الجذرية التي توفر الوقت والمال للعميل. هدفه الدائم: إعادة السيارة إلى حالتها المثالية بأعلى مستويات الجودة والأمان. للتواصل المباشر: <strong>0550 81 38 83</strong></p>
  </div>

  <h1 data-key="title">ورشة عباس أشلاف – حجز مواعيد الصيانة</h1>

  <div class="cards-wrapper">

    <div class="card">
      <div class="card-header" data-key="working-hours-title">مواقيت العمل</div>
      <div class="card-body">
        <ul class="working-hours">
          <li><span data-key="sunday">الأحد</span>     <span>09:00 – 16:00</span></li>
          <li><span data-key="monday">الإثنين</span>   <span>09:00 – 16:00</span></li>
          <li><span data-key="tuesday">الثلاثاء</span>  <span>09:00 – 16:00</span></li>
          <li><span data-key="wednesday">الأربعاء</span>  <span>09:00 – 16:00</span></li>
          <li><span data-key="thursday">الخميس</span>    <span>09:00 – 16:00</span></li>
          <li><span data-key="friday">الجمعة</span>    <span class="closed" data-key="closed">مغلق</span></li>
          <li><span data-key="saturday">السبت</span>     <span>09:30 – 16:00</span></li>
        </ul>
      </div>
    </div>

    <div class="card">
      <div class="card-header" data-key="booked-title">المواعيد المحجوزة</div>
      <div class="card-body">
        <ul class="booked-list" id="booked-list">
          <li class="empty" data-key="loading">جاري تحميل المواعيد...</li>
        </ul>
      </div>
    </div>

  </div>

  <div id="booking-form">
    <h2 data-key="book-now">احجز موعد جديد</h2>
    
    <form id="appointment-form">
      <div class="form-grid">
        <div>
          <label data-key="name-label">الاسم الكامل</label>
          <input type="text" id="name" required>
        </div>
        <div>
          <label data-key="phone-label">رقم الهاتف</label>
          <input type="tel" id="phone" required pattern="0[5-7][0-9]{8}">
        </div>
        <div>
          <label data-key="car-label">موديل السيارة</label>
          <input type="text" id="car" required placeholder="مثال: تويوتا كامري 2020">
        </div>
        <div>
          <label data-key="plate-label">رقم اللوحة (اختياري)</label>
          <input type="text" id="plate">
        </div>
        <div>
          <label data-key="date-label">تاريخ الموعد</label>
          <input type="date" id="date" required>
        </div>
        <div>
          <label data-key="time-label">الوقت</label>
          <select id="time" required>
            <option value="">اختر الوقت</option>
            <option value="09:00">09:00 – 10:30</option>
            <option value="10:30">10:30 – 12:00</option>
            <option value="12:00">12:00 – 13:30</option>
            <option value="13:30">13:30 – 15:00</option>
            <option value="15:00">15:00 – 16:00</option>
          </select>
        </div>
        <div class="full">
          <label data-key="issue-label">المشكلة الطارئة (مساعد طارئ)</label>
          <select id="emergency_issue" required>
            <option value="">-- اختر المشكلة --</option>
            <option value="oil_light">لمبة الزيت تضيء</option>
            <option value="overheating">تسخين زائد للمحرك</option>
            <option value="flat_tire">إطار مثقوب أو مفلطح</option>
            <option value="dead_battery">البطارية ميتة (السيارة لا تبدأ)</option>
            <option value="fluid_leak">تسرب سائل (زيت، ماء، إلخ)</option>
            <option value="brake_issue">مشكلة في الفرامل</option>
            <option value="engine_smoke">دخان من المحرك</option>
            <option value="other">أخرى</option>
          </select>
        </div>
        <div class="full" id="safety-advice" style="display: none;"></div>
        <div class="full">
          <label data-key="notes-label">ملاحظات إضافية</label>
          <textarea id="notes" rows="3" placeholder="وصف المشكلة إن وجدت..."></textarea>
        </div>
      </div>

      <button type="submit" data-key="submit-btn">تأكيد الحجز</button>
    </form>

    <div id="message"></div>
  </div>

  <!-- ميزة الدردشة -->
  <div id="chat-section">
    <h2 data-key="chat-title">دردشة مع الميكانيكي</h2>
    <div id="chat-messages"></div>
    <div class="chat-input">
      <input type="text" id="chat-input" placeholder="اكتب رسالتك هنا..." required>
      <button id="chat-send" data-key="send-btn">إرسال</button>
    </div>
  </div>

</div>

<script>
  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCLCSPOV1nuk5RvQiSJcjc18rxXbC0Ei9Y",
    authDomain: "bot-djasser-achlaf-4494.firebaseapp.com",
    databaseURL: "https://bot-djasser-achlaf-4494-default-rtdb.firebaseio.com",
    projectId: "bot-djasser-achlaf-4494",
    storageBucket: "bot-djasser-achlaf-4494.firebasestorage.app",
    messagingSenderId: "500557963512",
    appId: "1:500557963512:web:a32bf5c21ba508662b5b0d"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const appointmentsRef = db.ref('appointments');
  const chatRef = db.ref('chats'); // مسار للدردشة

  const bookedList = document.getElementById('booked-list');
  const form = document.getElementById('appointment-form');
  const messageDiv = document.getElementById('message');
  const emergencySelect = document.getElementById('emergency_issue');
  const safetyAdviceDiv = document.getElementById('safety-advice');
  const chatMessages = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const chatSend = document.getElementById('chat-send');

  // الترجمات
  const translations = {
    ar: {
      title: "ورشة عباس أشلاف – حجز مواعيد الصيانة",
      mechanic_name: "عباس أشلاف",
      mechanic_desc: "ميكانيكي محترف بخبرة تزيد عن 20 سنة في صيانة وإصلاح السيارات الأوروبية باحترافية عالية. متخصص بشكل خاص في مجموعة فولكس فاغن (Volkswagen, Škoda, Audi, SEAT León, SEAT Ibiza وغيرها). يمتلك خبرة عميقة في أنظمة الحقن الإلكتروني، التربو، DSG، نظام التعليق المتكيف، والتشخيص المتقدم بأحدث الأجهزة.",
      mechanic_bio: "<strong>سيرة ذاتية مختصرة:</strong> يمتلك عباس أشلاف خبرة تفوق 20 عامًا في مجال صيانة وإصلاح السيارات، مع تركيز قوي ومتخصص على ماركات مجموعة فولكس فاغن (فولكس فاغن، سكودا، أودي، سيات ليون، سيات إيبيزا وموديلات أخرى). يشتهر بالدقة الفائقة في التشخيص، استخدام أحدث تقنيات OBD والبرمجة، والحلول الجذرية التي توفر الوقت والمال للعميل. هدفه الدائم: إعادة السيارة إلى حالتها المثالية بأعلى مستويات الجودة والأمان. للتواصل المباشر: <strong>0550 81 38 83</strong>",
      working_hours_title: "مواقيت العمل",
      booked_title: "المواعيد المحجوزة",
      book_now: "احجز موعد جديد",
      loading: "جاري تحميل المواعيد...",
      sunday: "الأحد", monday: "الإثنين", tuesday: "الثلاثاء",
      wednesday: "الأربعاء", thursday: "الخميس", friday: "الجمعة",
      saturday: "السبت", closed: "مغلق",
      name_label: "الاسم الكامل",
      phone_label: "رقم الهاتف",
      car_label: "موديل السيارة",
      plate_label: "رقم اللوحة (اختياري)",
      date_label: "تاريخ الموعد",
      time_label: "الوقت",
      issue_label: "المشكلة الطارئة (مساعد طارئ)",
      notes_label: "ملاحظات إضافية",
      submit_btn: "تأكيد الحجز",
      chat_title: "دردشة مع الميكانيكي",
      send_btn: "إرسال"
    },
    fr: {
      title: "Atelier Abbas Achlaf – Réservation de rendez-vous",
      mechanic_name: "Abbas Achlaf",
      mechanic_desc: "Mécanicien professionnel avec plus de 20 ans d'expérience...",
      mechanic_bio: "<strong>Biographie courte :</strong> Abbas Achlaf possède plus de 20 ans d'expérience dans l'entretien et la réparation de véhicules, avec un focus particulier sur le groupe Volkswagen (Volkswagen, Škoda, Audi, SEAT León, SEAT Ibiza et autres). Il est réputé pour sa précision dans le diagnostic, l'utilisation des dernières technologies OBD et programmation, et des solutions radicales qui économisent du temps et de l'argent au client. Son objectif constant : ramener le véhicule à son état idéal avec les plus hauts niveaux de qualité et de sécurité. Pour contact direct: <strong>0550 81 38 83</strong>",
      working_hours_title: "Horaires de travail",
      booked_title: "Rendez-vous réservés",
      book_now: "Réserver un nouveau rendez-vous",
      loading: "Chargement des rendez-vous en cours...",
      sunday: "Dimanche", monday: "Lundi", tuesday: "Mardi",
      wednesday: "Mercredi", thursday: "Jeudi", friday: "Vendredi",
      saturday: "Samedi", closed: "Fermé",
      name_label: "Nom complet",
      phone_label: "Numéro de téléphone",
      car_label: "Modèle du véhicule",
      plate_label: "Numéro d'immatriculation (optionnel)",
      date_label: "Date du rendez-vous",
      time_label: "Heure",
      issue_label: "Problème urgent (assistant d'urgence)",
      notes_label: "Remarques supplémentaires",
      submit_btn: "Confirmer la réservation",
      chat_title: "Chat avec le mécanicien",
      send_btn: "Envoyer"
    },
    en: {
      title: "Abbas Achlaf Garage – Appointment Booking",
      mechanic_name: "Abbas Achlaf",
      mechanic_desc: "Professional mechanic with over 20 years of experience...",
      mechanic_bio: "<strong>Short Biography:</strong> Abbas Achlaf has more than 20 years of experience in vehicle maintenance and repair, with a strong focus on the Volkswagen Group brands (Volkswagen, Škoda, Audi, SEAT León, SEAT Ibiza and others). He is known for his precision in diagnosis, use of the latest OBD technologies and programming, and root solutions that save time and money for the client. His constant goal: restore the vehicle to its ideal state with the highest levels of quality and safety. For direct contact: <strong>0550 81 38 83</strong>",
      working_hours_title: "Working Hours",
      booked_title: "Booked Appointments",
      book_now: "Book a New Appointment",
      loading: "Loading appointments...",
      sunday: "Sunday", monday: "Monday", tuesday: "Tuesday",
      wednesday: "Wednesday", thursday: "Thursday", friday: "Friday",
      saturday: "Saturday", closed: "Closed",
      name_label: "Full Name",
      phone_label: "Phone Number",
      car_label: "Car Model",
      plate_label: "License Plate (optional)",
      date_label: "Appointment Date",
      time_label: "Time",
      issue_label: "Emergency Issue (Emergency Assistant)",
      notes_label: "Additional Notes",
      submit_btn: "Confirm Booking",
      chat_title: "Chat with the Mechanic",
      send_btn: "Send"
    }
  };

  // تغيير اللغة
  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const lang = btn.dataset.lang;
      document.body.dataset.lang = lang;
      document.body.dir = (lang === 'ar') ? 'rtl' : 'ltr';

      document.querySelectorAll('[data-key]').forEach(el => {
        const key = el.dataset.key;
        if (translations[lang][key]) el.innerHTML = translations[lang][key];
      });

      document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

  // عرض الحجوزات في الوقت الفعلي
  appointmentsRef.on('value', (snapshot) => {
    bookedList.innerHTML = '';

    if (!snapshot.exists() || Object.keys(snapshot.val() || {}).length === 0) {
      bookedList.innerHTML = `<li class="empty">${translations[document.body.dataset.lang].loading}</li>`;
      return;
    }

    const data = snapshot.val();
    Object.entries(data).forEach(([key, appt]) => {
      const li = document.createElement('li');
      li.className = 'booked-item';
      li.innerHTML = `
        <div class="booked-header">
          <span>${appt.date || 'غير محدد'}</span>
          <span class="status">محجوز</span>
        </div>
        <div>${appt.time || 'غير محدد'}</div>
        <div style="color:#475569; margin-top:0.4rem;">
          ${appt.name} – ${appt.car || ''} – ${appt.issue || ''}
        </div>
      `;
      bookedList.appendChild(li);
    });
  });

  // ضبط الحد الأدنى للتاريخ = اليوم
  document.getElementById('date').min = new Date().toISOString().split('T')[0];

  // نصائح الأمان (مختصرة هنا – يمكن إضافة باقيها)
  const safetyProtocols = {
    oil_light: {
      ar: "<h4>نصيحة أمان فورية:</h4><p>إذا أضاءت لمبة الزيت، توقف السيارة مباشرة في مكان آمن بعيداً عن الطريق. أطفئ المحرك ودع السيارة تبرد تماماً لمدة 30 دقيقة على الأقل. لا تقد السيارة أكثر لتجنب تلف المحرك. بعد ذلك، احجز موعد عند عباس الميكانيكي لفحص مستوى الزيت والضغط.</p>",
      fr: "<h4>Conseil de sécurité immédiat :</h4><p>Si le voyant d'huile s'allume, arrêtez immédiatement le véhicule dans un endroit sûr loin de la route. Éteignez le moteur et laissez la voiture refroidir complètement pendant au moins 30 minutes. Ne conduisez plus pour éviter d'endommager le moteur. Ensuite, prenez rendez-vous avec Abbas le mécanicien pour vérifier le niveau d'huile et la pression.</p>",
      en: "<h4>Immediate Safety Advice:</h4><p>If the oil light comes on, stop the car immediately in a safe place away from the road. Turn off the engine and let the car cool completely for at least 30 minutes. Do not drive further to avoid engine damage. Then book an appointment with Abbas the mechanic to check oil level and pressure.</p>"
    },
    overheating: {
      ar: "<h4>نصيحة أمان فورية:</h4><p>توقف في مكان آمن، أطفئ المحرك فوراً، ودع السيارة تبرد لساعة على الأقل. لا تفتح غطاء الرادياتير إلا بعد التبريد الكامل لتجنب الحروق. شغل المدفأة لمساعدة في التبريد إذا لزم الأمر. احجز موعد لفحص نظام التبريد.</p>",
      fr: "<h4>Conseil de sécurité immédiat :</h4><p>Arrêtez dans un endroit sûr, éteignez le moteur immédiatement et laissez la voiture refroidir au moins une heure. N'ouvrez le bouchon du radiateur qu'après refroidissement complet pour éviter les brûlures. Allumez le chauffage pour aider au refroidissement si nécessaire. Prenez rendez-vous pour vérifier le système de refroidissement.</p>",
      en: "<h4>Immediate Safety Advice:</h4><p>Stop in a safe place, turn off the engine immediately, and let the car cool for at least one hour. Do not open the radiator cap until fully cooled to avoid burns. Turn on the heater to help cooling if needed. Book an appointment to check the cooling system.</p>"
    },
    flat_tire: {
      ar: "<h4>نصيحة أمان فورية:</h4><p>حافظ على سيطرة المقود، ابطئ تدريجياً، وتوقف في سطح مستوٍ آمن بعيداً عن الحركة. شغل أنوار الطوارئ، وضع مثلث التحذير خلف السيارة. إذا كنت تستطيع، غير الإطار بنفسك؛ وإلا انتظر المساعدة داخل السيارة. احجز موعد لإصلاح أو استبدال الإطار.</p>",
      fr: "<h4>Conseil de sécurité immédiat :</h4><p>Maintenez le contrôle du volant, ralentissez progressivement et arrêtez sur une surface plane sûre loin de la circulation. Allumez les feux de détresse, placez le triangle de signalisation derrière la voiture. Si vous le pouvez, changez le pneu vous-même ; sinon, attendez l'aide à l'intérieur du véhicule. Prenez rendez-vous pour réparer ou remplacer le pneu.</p>",
      en: "<h4>Immediate Safety Advice:</h4><p>Maintain steering control, slow down gradually, and stop on a flat safe surface away from traffic. Turn on hazard lights, place the warning triangle behind the car. If you can, change the tire yourself; otherwise wait for help inside the car. Book an appointment to repair or replace the tire.</p>"
    },
    dead_battery: {
      ar: "<h4>نصيحة أمان فورية:</h4><p>توقف في مكان آمن، شغل أنوار الطوارئ. إذا كان لديك كوابل شحن، اطلب مساعدة من سيارة أخرى، لكن كن حذراً من الشرارات. انتظر داخل السيارة إذا كنت تنتظر المساعدة. احجز موعد لفحص البطارية والنظام الكهربائي.</p>",
      fr: "<h4>Conseil de sécurité immédiat :</h4><p>Arrêtez dans un endroit sûr, allumez les feux de détresse. Si vous avez des câbles de charge, demandez l'aide d'un autre véhicule, mais soyez prudent avec les étincelles. Attendez à l'intérieur de la voiture si vous attendez de l'aide. Prenez rendez-vous pour vérifier la batterie et le système électrique.</p>",
      en: "<h4>Immediate Safety Advice:</h4><p>Stop in a safe place, turn on hazard lights. If you have jumper cables, ask for help from another car, but be careful with sparks. Wait inside the car if waiting for help. Book an appointment to check the battery and electrical system.</p>"
    },
    fluid_leak: {
      ar: "<h4>نصيحة أمان فورية:</h4><p>توقف في مكان آمن، أطفئ المحرك، وتحقق من نوع السائل (زيت، ماء، إلخ) دون لمسه إذا كان ساخناً. لا تقد السيارة إذا كان التسرب كبيراً لتجنب تلف المحرك أو الحريق. احجز موعد فوري لإصلاح التسرب.</p>",
      fr: "<h4>Conseil de sécurité immédiat :</h4><p>Arrêtez dans un endroit sûr, éteignez le moteur et vérifiez le type de fluide (huile, eau, etc.) sans le toucher s'il est chaud. Ne conduisez pas si la fuite est importante pour éviter d'endommager le moteur ou un incendie. Prenez rendez-vous immédiat pour réparer la fuite.</p>",
      en: "<h4>Immediate Safety Advice:</h4><p>Stop in a safe place, turn off the engine, and check the type of fluid (oil, water, etc.) without touching if hot. Do not drive if the leak is large to avoid engine damage or fire. Book an immediate appointment to repair the leak.</p>"
    },
    brake_issue: {
      ar: "<h4>نصيحة أمان فورية:</h4><p>إذا شعرت بمشكلة في الفرامل، ابطئ باستخدام فرامل اليد تدريجياً، وتوقف في مكان آمن. شغل أنوار الطوارئ ولا تقد أكثر. انتظر المساعدة داخل السيارة. احجز موعد لفحص نظام الفرامل فوراً.</p>",
      fr: "<h4>Conseil de sécurité immédiat :</h4><p>Si vous sentez un problème avec les freins, ralentissez progressivement avec le frein à main et arrêtez dans un endroit sûr. Allumez les feux de détresse et ne conduisez plus. Attendez l'aide à l'intérieur de la voiture. Prenez rendez-vous pour vérifier le système de freinage immédiatement.</p>",
      en: "<h4>Immediate Safety Advice:</h4><p>If you feel a brake problem, slow down gradually using the handbrake and stop in a safe place. Turn on hazard lights and do not drive further. Wait for help inside the car. Book an appointment to check the brake system immediately.</p>"
    },
    engine_smoke: {
      ar: "<h4>نصيحة أمان فورية:</h4><p>توقف فوراً في مكان آمن، أطفئ المحرك، وابتعد عن السيارة لتجنب الحريق. شغل أنوار الطوارئ وضع مثلث التحذير. لا تفتح غطاء المحرك إذا كان هناك دخان كثيف. احجز موعد لفحص المحرك.</p>",
      fr: "<h4>Conseil de sécurité immédiat :</h4><p>Arrêtez immédiatement dans un endroit sûr, éteignez le moteur et éloignez-vous du véhicule pour éviter un incendie. Allumez les feux de détresse et placez le triangle d'avertissement. N'ouvrez pas le capot du moteur s'il y a beaucoup de fumée. Prenez rendez-vous pour vérifier le moteur.</p>",
      en: "<h4>Immediate Safety Advice:</h4><p>Stop immediately in a safe place, turn off the engine, and move away from the car to avoid fire. Turn on hazard lights and place the warning triangle. Do not open the engine hood if there is thick smoke. Book an appointment to check the engine.</p>"
    },
    other: {
      ar: "<h4>نصيحة أمان عامة:</h4><p>توقف في مكان آمن، شغل أنوار الطوارئ، وابق داخل السيارة مع قفل الأبواب. لا تقم بإصلاح ذاتي إلا إذا كنت خبيراً. احجز موعد وصف المشكلة في الملاحظات لمساعدتنا.</p>",
      fr: "<h4>Conseil de sécurité général :</h4><p>Arrêtez dans un endroit sûr, allumez les feux de détresse et restez dans la voiture portes verrouillées. N'essayez pas de réparer vous-même sauf si vous êtes expert. Prenez rendez-vous et décrivez le problème dans les remarques pour nous aider.</p>",
      en: "<h4>General Safety Advice:</h4><p>Stop in a safe place, turn on hazard lights, and stay inside the car with doors locked. Do not attempt self-repair unless you are an expert. Book an appointment and describe the problem in notes to help us.</p>"
    }
  };

  emergencySelect.addEventListener('change', (e) => {
    const issue = e.target.value;
    const lang = document.body.dataset.lang;
    if (issue && safetyProtocols[issue] && safetyProtocols[issue][lang]) {
      safetyAdviceDiv.innerHTML = safetyProtocols[issue][lang];
      safetyAdviceDiv.style.display = 'block';
    } else {
      safetyAdviceDiv.style.display = 'none';
    }
  });

  // حفظ حجز مع منع التعارض
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const lang = document.body.dataset.lang;

    const newAppt = {
      name:   document.getElementById('name').value.trim(),
      phone:  document.getElementById('phone').value.trim(),
      car:    document.getElementById('car').value.trim(),
      plate:  document.getElementById('plate').value.trim() || null,
      date:   document.getElementById('date').value,
      time:   document.getElementById('time').value,
      issue:  document.getElementById('emergency_issue').value,
      notes:  document.getElementById('notes').value.trim() || null,
      createdAt: firebase.database.ServerValue.TIMESTAMP
    };

    if (!newAppt.name || !newAppt.phone || !newAppt.date || !newAppt.time || !newAppt.issue) {
      messageDiv.textContent = lang === 'ar' ? 'يرجى ملء جميع الحقول المطلوبة' : 
                               lang === 'fr' ? 'Veuillez remplir tous les champs obligatoires' : 
                               'Please fill in all required fields';
      messageDiv.className = 'error';
      return;
    }

    // التحقق من التعارض
    const snapshot = await appointmentsRef.orderByChild('date').equalTo(newAppt.date).once('value');

    let conflict = false;

    if (snapshot.exists()) {
      snapshot.forEach(child => {
        const existing = child.val();
        if (existing.time === newAppt.time) {
          conflict = true;
        }
      });
    }

    if (conflict) {
      messageDiv.textContent = lang === 'ar' ? 'هذا الموعد محجوز مسبقاً! اختر وقتاً آخر.' :
                               lang === 'fr' ? 'Ce créneau est déjà réservé ! Choisissez un autre horaire.' :
                               'This time slot is already booked! Please choose another time.';
      messageDiv.className = 'error';
      return;
    }

    // حفظ
    await appointmentsRef.push(newAppt);

    messageDiv.textContent = lang === 'ar' ? 'تم حفظ الحجز بنجاح! سيتم التواصل معك قريباً.' :
                             lang === 'fr' ? 'Rendez-vous enregistré avec succès ! Nous vous contacterons bientôt.' :
                             'Booking saved successfully! We will contact you soon.';
    messageDiv.className = 'success';
    form.reset();
    safetyAdviceDiv.style.display = 'none';

  } catch (error) {
    messageDiv.textContent = (lang === 'ar' ? 'حدث خطأ أثناء الحفظ: ' : 
                             lang === 'fr' ? 'Erreur lors de l'enregistrement : ' : 
                             'Error saving: ') + error.message;
    messageDiv.className = 'error';
    console.error(error);
  }
  });

  // ميزة الدردشة (real-time)
  chatRef.on('value', (snapshot) => {
    chatMessages.innerHTML = '';
    if (snapshot.exists()) {
      snapshot.forEach(child => {
        const msg = child.val();
        const div = document.createElement('div');
        div.className = 'chat-message ' + (msg.user === 'mechanic' ? 'mechanic' : 'user');
        div.innerHTML = `<strong>${msg.user === 'mechanic' ? 'الميكانيكي' : 'أنت'}</strong>: ${msg.text} <small>${new Date(msg.timestamp).toLocaleString()}</small>`;
        chatMessages.appendChild(div);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    } else {
      chatMessages.innerHTML = '<p>ابدأ الدردشة الآن!</p>';
    }
  });

  chatSend.addEventListener('click', () => {
    const text = chatInput.value.trim();
    if (text) {
      chatRef.push({
        user: 'user', // من جانب العميل (يمكن تغيير لـ mechanic من لوحة الإدارة)
        text: text,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
      chatInput.value = '';
    }
  });

  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') chatSend.click();
  });
</script>

</body>
</html>
